name: Python application

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  train:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/requirements.txt
    - name: Train the model
      run: |
        python src/model.py
    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: model
        path: model.joblib

  build:
    needs: train
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Download model
      uses: actions/download-artifact@v2
      with:
        name: model
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/requirements.txt
    - name: Run the application
      run: |
        gunicorn --bind 0.0.0.0:5000 src.app:app &
        sleep 5
    - name: Run prediction
      id: predict
      run: |
        python src/predict.py
    - name: Rollback
      if: failure() && steps.predict.conclusion == 'failure'
      run: |
        echo "Anomaly detected! Rolling back the deployment."
    - name: Test metrics
      run: |
        curl http://127.0.0.1:5000/
        curl http://127.0.0.1:5000/metrics
        curl http://127.0.0.1:5000/anomaly
